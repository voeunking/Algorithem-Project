{% extends 'base.html' %}

{% block breadcrumb %}
  <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Home</a></li>
  <li class="breadcrumb-item active" aria-current="page">Transactions</li>
{% endblock %}

{% block content %}
<div class="container mt-2" id="tx-page">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <h2 class="mb-0">ðŸ“‹ Transactions</h2>
    <a href="{{ url_for('transaction_bp.issue_book') }}" class="btn btn-success">
      <i class="fas fa-plus-circle me-1"></i> Issue Book
    </a>
  </div>

  {% if stats %}
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="card stat-card border-0 shadow-sm">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted small">Total</div>
            <div class="h4 mb-0">{{ stats.total }}</div>
          </div>
          <i class="fas fa-list fa-2x text-primary"></i>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card stat-card border-0 shadow-sm">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted small">Issued</div>
            <div class="h4 mb-0">{{ stats.issued }}</div>
          </div>
          <i class="fas fa-arrow-right fa-2x text-warning"></i>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card stat-card border-0 shadow-sm">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted small">Returned</div>
            <div class="h4 mb-0">{{ stats.returned }}</div>
          </div>
          <i class="fas fa-check fa-2x text-success"></i>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Filters -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Search</label>
          <input type="text" id="tx-search" class="form-control" placeholder="Search member or book...">
        </div>
        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select id="tx-status" class="form-select">
            <option value="all" selected>All</option>
            <option value="issued">Issued</option>
            <option value="returned">Returned</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">From</label>
          <input type="date" id="tx-from" class="form-control">
        </div>
        <div class="col-md-2">
          <label class="form-label">To</label>
          <input type="date" id="tx-to" class="form-control">
        </div>
        <div class="col-md-1 d-grid">
          <button class="btn btn-outline-secondary" id="tx-reset">Reset</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Inline Issue Book (optional) -->
  {% if members and books %}
  <form action="{{ url_for('transaction_bp.issue_book') }}" method="POST" class="mb-3">
    <div class="row g-3 align-items-end">
      <div class="col-md-4">
        <label for="member_id" class="form-label">Select Member</label>
        <select name="member_id" class="form-select" required>
          {% for m in members %}
          <option value="{{ m.id }}">{{ m.full_name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label for="book_id" class="form-label">Select Book</label>
        <select name="book_id" class="form-select" required>
          {% for b in books %}
          <option value="{{ b.id }}">{{ b.title }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4 d-grid">
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-arrow-right me-1"></i> Issue Book
        </button>
      </div>
    </div>
  </form>
  {% endif %}

  <!-- Transactions Table -->
  {% if transactions %}
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle" id="tx-table">
      <thead class="table-dark">
        <tr>
          <th data-sort="id" class="sortable">ID</th>
          <th data-sort="member" class="sortable">Member</th>
          <th data-sort="book" class="sortable">Book</th>
          <th data-sort="issue" class="sortable">Issue Date</th>
          <th data-sort="return" class="sortable">Return Date</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for t in transactions %}
        {% set is_returned = 1 if t.return_date else 0 %}
        <tr data-id="{{ t.id }}" data-member="{{ t.member_name|lower }}" data-book="{{ t.book_title|lower }}"
            data-issue="{{ t.issue_date }}" data-return="{{ t.return_date or '' }}"
            data-status="{{ 'returned' if is_returned else 'issued' }}">
          <td>{{ t.id }}</td>
          <td>{{ t.member_name }}</td>
          <td>{{ t.book_title }}</td>
          <td>{{ t.issue_date }}</td>
          <td>{{ t.return_date or 'Not Returned' }}</td>
          <td>
            {% if not t.return_date %}
            <span class="badge bg-warning text-dark">Issued</span>
            {% else %}
            <span class="badge bg-success">Returned</span>
            {% endif %}
          </td>
          <td>
            {% if not t.return_date %}
            <a href="{{ url_for('transaction_bp.return_book', transaction_id=t.id) }}" class="btn btn-primary btn-sm">Return</a>
            {% else %}
            <span class="text-muted">-</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="text-center text-muted">No transactions yet.</p>
  {% endif %}
</div>

<style>
  /* Scoped to transactions page */
  #tx-page .stat-card { background: #fff; }
  #tx-page .sortable { cursor: pointer; }
  #tx-page .sortable:after { content: '\\f0dc'; font-family: 'Font Awesome 6 Free'; font-weight: 900; margin-left: .4rem; opacity: .4; }
  #tx-page .badge { font-size: .85rem; }
  #tx-page .form-label { font-weight: 600; color: #344767; }
</style>

{% block extra_js %}
<script>
  (function() {
    const search = document.getElementById('tx-search');
    const statusSel = document.getElementById('tx-status');
    const from = document.getElementById('tx-from');
    const to = document.getElementById('tx-to');
    const resetBtn = document.getElementById('tx-reset');
    const tbody = document.querySelector('#tx-table tbody');

    function parseDate(s) { return s ? new Date(s.replace(' ', 'T')) : null; }

    function applyFilters() {
      const q = (search?.value || '').trim().toLowerCase();
      const st = statusSel?.value || 'all';
      const f = from?.value ? new Date(from.value) : null;
      const t = to?.value ? new Date(to.value) : null;
      tbody.querySelectorAll('tr').forEach(tr => {
        const member = tr.dataset.member || '';
        const book = tr.dataset.book || '';
        const issue = parseDate(tr.dataset.issue);
        const ret = parseDate(tr.dataset.return);
        const status = tr.dataset.status;

        let vis = true;
        if (q && !(member.includes(q) || book.includes(q))) vis = false;
        if (st !== 'all' && status !== st) vis = false;
        if (f && issue && issue < f) vis = false;
        if (t && issue && issue > t) vis = false;
        tr.style.display = vis ? '' : 'none';
      });
    }

    search?.addEventListener('input', applyFilters);
    statusSel?.addEventListener('change', applyFilters);
    from?.addEventListener('change', applyFilters);
    to?.addEventListener('change', applyFilters);
    resetBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      if (search) search.value = '';
      if (statusSel) statusSel.value = 'all';
      if (from) from.value = '';
      if (to) to.value = '';
      applyFilters();
    });

    // Simple sort
    const getCell = (tr, idx) => tr.children[idx].innerText.trim().toLowerCase();
    document.querySelectorAll('#tx-table thead th.sortable').forEach((th, idx) => {
      th.addEventListener('click', () => {
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const asc = th.dataset.asc !== 'true';
        th.dataset.asc = asc;
        rows.sort((a, b) => {
          const av = getCell(a, idx);
          const bv = getCell(b, idx);
          if (!isNaN(av) && !isNaN(bv)) return (parseFloat(av) - parseFloat(bv)) * (asc ? 1 : -1);
          return av.localeCompare(bv) * (asc ? 1 : -1);
        });
        rows.forEach(r => tbody.appendChild(r));
      });
    });

    applyFilters();
  })();
</script>
{% endblock %}
{% endblock %}